{% extends "core/base_generic.html" %}
{% load render_table from django_tables2 %}
{% load crispy from crispy_forms_tags %}
{% load static from static %}
{% block script %}
    <script>function copyToken(token_str) {navigator.clipboard.writeText(token_str);}</script>
{% endblock script %}
{% block container %}
    <div class="d-flex justify-content-between align-items-start">
        <h4 class="mb-3">REST Authentication Tokens</h4>
        {% include "core/_help_button.html" with target="#generate_token_help_modal" only %}
    </div>
    <!-- list of all tokens -->
    <div style="margin-top: 40px;">
        <h5>Existing tokens</h5>
        <table class="table table-hover" id="token-list-wrapper">
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Token</th>
                    <th>Created</th>
                    <th>Expires</th>
                    <th>Last Used</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for token in Tokens reversed %}
                    <tr id="token-str-{{ token.client }}">
                        <td>{{ token.client }}</td>
                        <td>{{ token.fraction }} ...</td>
                        <td>{{ token.created_time }}</td>
                        <td>{{ token.expiry_time }}</td>
                        <td>{{ token.last_used }}</td>
                        <td>
                            <form action="{% url "delete_token" %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="client" value="{{ token.client }}">
                                <button type="submit" class="btn btn-danger btn-sm">{% include "core/_trash_can.svg" %}</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- generate token form -->
    <div style="margin-top: 40px;">
        <h5>Generate a new token</h5>
        <form action={% url "generate_token" %} method="post">
            {% csrf_token %}
            {% crispy GenerateTokenForm %}
        </form>
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == "success" %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5>Sucessfully generated a REST authentication token.</h5>
                            This token will only be visible once, so make sure to copy it
                            now and store it in a safe place. As you will not be able to
                            see it again, you will have to generate a new token if you lose
                            it.
                            <br>
                            <br>
                            <h3>
                                <span class="badge badge-light">{{ message }}
                                    <button id="copy-token-button"
                                            class="btn btn-light btn-sm ml-1"
                                            onclick="copyToken('{{ message }}')">
                                        {% include "core/_clipboard.svg" %}
                                    </button>
                                </span>
                            </h3>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endblock container %}
{% block bottom %}
    {% include 'token_authentication/_generate_token_help_modal.html' with modal_id="generate_token_help_modal" %}
{% endblock bottom %}
